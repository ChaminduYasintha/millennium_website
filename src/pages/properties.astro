---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { supabase, type Property } from '../lib/supabaseClient';

export const prerender = false;


// Fetch properties from Supabase
let properties: Property[] = [];
let error: string | null = null;

try {
  const { data, error: fetchError } = await supabase
    .from('properties')
    .select('*')
    .order('created_at', { ascending: false });
  
  if (fetchError) {
    error = fetchError.message;
    console.error('Error fetching properties:', fetchError);
  } else {
    properties = data || [];
  }
} catch (e) {
  error = 'Failed to connect to database';
  console.error('Database connection error:', e);
}
---

<BaseLayout 
  title="Property Portfolio - Land & Houses in Kandy"
  description="Browse our premium land and property listings in Haragama, Katugastota, and Peradeniya. All properties come with clear deeds and utility access."
>
  <Navigation />
  
  <!-- Header Section -->
  <section class="pt-32 pb-12 bg-gradient-to-b from-navy-darker to-navy-dark">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto">
        <span class="inline-block px-4 py-2 bg-gold/10 border border-gold/30 text-gold rounded-full text-sm font-semibold mb-4">
          üèòÔ∏è Property Portfolio
        </span>
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-4">
          Find Your Perfect <span class="text-gold">Property</span>
        </h1>
        <p class="text-xl text-cream/80">
          Premium land and properties in Kandy's most desirable locations
        </p>
      </div>
    </div>
  </section>
  
  <!-- Main Content Area -->
  <section class="py-12 bg-navy-darker min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row gap-8">
        
        <!-- Sidebar Filters -->
        <aside class="w-full lg:w-1/4">
          <div class="sticky top-24 bg-navy-dark p-6 rounded-2xl border border-gold/20 shadow-xl shadow-black/20">
            <h3 class="text-xl font-bold text-white mb-6 border-b border-gold/20 pb-4 flex items-center">
              <svg class="w-5 h-5 mr-2 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
              </svg>
              Filter Properties
            </h3>
            
            <!-- Search Bar -->
            <div class="mb-8">
              <label for="search-input" class="block text-sm font-medium text-cream/70 mb-2">Search</label>
              <div class="relative">
                <input 
                  type="text" 
                  id="search-input" 
                  placeholder="Search properties..." 
                  class="w-full pl-10 pr-4 py-3 bg-navy-light text-white border border-gold/20 rounded-lg focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold/50 transition-colors placeholder-cream/30"
                />
                <svg class="w-5 h-5 text-gold/50 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
            </div>
            
            <!-- Location Filters -->
            <div class="mb-8">
              <h4 class="text-gold font-semibold mb-4 text-sm uppercase tracking-wider">Location</h4>
              <div class="space-y-2">
                <button class="filter-btn active w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center justify-between group" data-filter="all">
                  <span>All Properties</span>
                  <div class="w-2 h-2 rounded-full bg-gold opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
                </button>
                <button class="filter-btn w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center justify-between group" data-filter="haragama">
                  <span>Haragama</span>
                  <div class="w-2 h-2 rounded-full bg-gold opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
                </button>
                <button class="filter-btn w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center justify-between group" data-filter="katugastota">
                  <span>Katugastota</span>
                  <div class="w-2 h-2 rounded-full bg-gold opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
                </button>
                <button class="filter-btn w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex items-center justify-between group" data-filter="peradeniya">
                  <span>Peradeniya</span>
                  <div class="w-2 h-2 rounded-full bg-gold opacity-0 group-[.active]:opacity-100 transition-opacity"></div>
                </button>
              </div>
            </div>
            
            <!-- Utility Filters -->
            <div>
              <h4 class="text-gold font-semibold mb-4 text-sm uppercase tracking-wider">Utilities</h4>
              <div class="space-y-3">
                <label class="flex items-center space-x-3 cursor-pointer group">
                  <div class="relative flex items-center">
                    <input type="checkbox" class="utility-filter peer sr-only" data-utility="water" />
                    <div class="w-5 h-5 border-2 border-gold/30 rounded bg-navy-light peer-checked:bg-gold peer-checked:border-gold transition-colors"></div>
                    <svg class="w-3 h-3 text-navy-dark absolute left-1 top-1 opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <span class="text-cream/80 group-hover:text-white transition-colors">üíß Water</span>
                </label>
                
                <label class="flex items-center space-x-3 cursor-pointer group">
                  <div class="relative flex items-center">
                    <input type="checkbox" class="utility-filter peer sr-only" data-utility="electricity" />
                    <div class="w-5 h-5 border-2 border-gold/30 rounded bg-navy-light peer-checked:bg-gold peer-checked:border-gold transition-colors"></div>
                    <svg class="w-3 h-3 text-navy-dark absolute left-1 top-1 opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <span class="text-cream/80 group-hover:text-white transition-colors">‚ö° Electricity</span>
                </label>
                
                <label class="flex items-center space-x-3 cursor-pointer group">
                  <div class="relative flex items-center">
                    <input type="checkbox" class="utility-filter peer sr-only" data-utility="telephone" />
                    <div class="w-5 h-5 border-2 border-gold/30 rounded bg-navy-light peer-checked:bg-gold peer-checked:border-gold transition-colors"></div>
                    <svg class="w-3 h-3 text-navy-dark absolute left-1 top-1 opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                  <span class="text-cream/80 group-hover:text-white transition-colors">üìû Telephone</span>
                </label>
              </div>
            </div>
            
          </div>
        </aside>
        
        <!-- Properties Grid Area -->
        <div class="w-full lg:w-3/4">
          
          <!-- Results Count -->
          <div class="mb-6 flex items-center justify-between text-cream/60 text-sm">
            <span id="results-count">Showing all properties</span>
            <div class="flex items-center">
              <span class="mr-2">Sort by:</span>
              <select class="bg-navy-dark border border-gold/20 rounded px-2 py-1 text-white focus:outline-none focus:border-gold text-xs">
                <option>Newest First</option>
                <option>Price: Low to High</option>
                <option>Price: High to Low</option>
              </select>
            </div>
          </div>
          
          {error ? (
            <div class="bg-navy-light border border-gold/30 rounded-xl p-8 text-center">
              <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <h3 class="text-xl font-bold text-white mb-2">Unable to Load Properties</h3>
              <p class="text-cream/70 mb-6">{error}</p>
              <p class="text-sm text-cream/50">Please make sure Supabase is configured properly in your .env file</p>
            </div>
          ) : properties.length === 0 ? (
            <div class="bg-navy-light border border-gold/30 rounded-xl p-12 text-center">
              <svg class="w-16 h-16 text-gold mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <h3 class="text-xl font-bold text-white mb-2">No Properties Available</h3>
              <p class="text-cream/70 mb-6">We're currently updating our property listings. Please check back soon!</p>
              <a href="/contact" class="inline-block px-6 py-3 bg-gold text-navy-dark font-bold rounded-lg hover:bg-gold-light transition-colors">
                Contact Us for Inquiries
              </a>
            </div>
          ) : (
            <>
                  <div id="properties-grid" class="grid md:grid-cols-2 gap-6">
                {properties.map((property) => (
                  <div 
                    class="property-card group bg-navy-light/50 backdrop-blur-sm rounded-2xl overflow-hidden border-2 border-gold/20 hover:border-gold transition-all duration-500 hover:shadow-xl hover:shadow-gold/20 transform hover:-translate-y-2 flex flex-col"
                    data-location={property.location.toLowerCase().replace(/\s+/g, '-')}
                    data-water={property.has_water}
                    data-electricity={property.has_electricity}
                    data-telephone={property.has_telephone}
                    data-title={property.title.toLowerCase()}
                    data-desc={property.description.toLowerCase()}
                  >
                    <!-- Link Wrapper -->
                    <a href={`/properties/${property.id}`} class="block relative h-56 bg-gradient-to-br from-gold/10 to-gold-pale overflow-hidden">
                      {property.images && property.images.length > 0 ? (
                        <img 
                          src={property.images[0]} 
                          alt={property.title}
                          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        />
                      ) : (
                        <div class="w-full h-full flex items-center justify-center">
                          <svg class="w-24 h-24 text-gold/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                        </div>
                      )}
                      
                      <!-- Badge -->
                      <div class="absolute top-4 left-4 bg-gold text-navy-dark px-3 py-1 rounded-full text-xs font-bold z-10">
                        {property.location}
                      </div>
                      
                      <!-- Hover Overlay -->
                      <div class="absolute inset-0 bg-navy-dark/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                         <span class="bg-white/90 text-navy-dark px-4 py-2 rounded-lg font-bold transform translate-y-4 group-hover:translate-y-0 transition-transform">View Details</span>
                      </div>
                    </a>
                    
                    <!-- Content -->
                    <div class="p-6 flex-grow flex flex-col">
                      <a href={`/properties/${property.id}`}>
                        <h3 class="text-xl font-bold text-white mb-2 group-hover:text-gold transition-colors">
                            {property.title}
                        </h3>
                      </a>
                      
                      <p class="text-cream/70 text-sm mb-4 line-clamp-2">
                        {property.description}
                      </p>
                      
                      <div class="mt-auto">
                        <!-- Price & Size -->
                        <div class="flex items-baseline justify-between mb-4 pb-4 border-b border-gold/20">
                          <div>
                            <div class="text-2xl font-bold text-gold">
                              Rs. {property.perch_price.toLocaleString()}
                            </div>
                            <div class="text-xs text-cream/60">per perch</div>
                          </div>
                          <div class="text-right">
                            <div class="text-lg font-semibold text-white">
                              {property.total_perches} p
                            </div>
                            <div class="text-xs text-cream/60">
                              {(property.perch_price * property.total_perches).toLocaleString()} total
                            </div>
                          </div>
                        </div>
                        
                        <!-- Utilities Mini Pills -->
                        <div class="flex flex-wrap gap-2 mb-4">
                          {property.has_water && (
                            <span class="px-2 py-1 bg-blue-500/10 border border-blue-500/30 text-blue-400 rounded text-[10px] uppercase font-bold tracking-wider">Water</span>
                          )}
                          {property.has_electricity && (
                            <span class="px-2 py-1 bg-yellow-500/10 border border-yellow-500/30 text-yellow-400 rounded text-[10px] uppercase font-bold tracking-wider">Power</span>
                          )}
                          {property.has_telephone && (
                            <span class="px-2 py-1 bg-green-500/10 border border-green-500/30 text-green-400 rounded text-[10px] uppercase font-bold tracking-wider">Tel</span>
                          )}
                        </div>
                        
                        <!-- Agent & Actions -->
                        <div class="flex items-center justify-between pt-4 border-t border-gold/20">
                          <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-gold/10 rounded-full flex items-center justify-center">
                              <svg class="w-4 h-4 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                              </svg>
                            </div>
                            <div>
                              <div class="text-xs text-cream/60">Agent</div>
                              <div class="text-sm font-semibold text-white">{property.agent_name.split(' ')[0]}</div>
                            </div>
                          </div>
                          
                          <div class="flex space-x-2">
                             <a 
                                href={`/properties/${property.id}`}
                                class="px-3 py-2 border border-gold/30 text-gold hover:bg-gold hover:text-navy-dark rounded-lg text-sm transition-colors"
                             >
                                Details
                             </a>
                             <a 
                                href={`https://wa.me/${property.agent_phone.replace(/\+/g, '').replace(/\s/g, '')}?text=I'm interested in ${property.title}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="px-3 py-2 bg-gold hover:bg-gold-light text-navy-dark font-bold rounded-lg text-sm transition-all transform hover:scale-105"
                             >
                                Inquire
                             </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              
              <!-- No Results State (Hidden by default) -->
              <div id="no-results" class="hidden text-center py-20 px-6 bg-navy-light/30 rounded-2xl border border-gold/10">
                <svg class="w-16 h-16 text-cream/30 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <h3 class="text-xl font-bold text-white mb-2">No Matching Properties</h3>
                <p class="text-cream/70">Unique search. Try adjusting your filters or search terms.</p>
                <button id="clear-filters" class="mt-6 px-6 py-2 bg-navy-light border border-gold/30 text-gold hover:bg-gold hover:text-navy-dark rounded-lg transition-colors">
                  Clear All Filters
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  </section>
  
  <Footer />
</BaseLayout>

<script>
  // Filter functionality
  document.addEventListener('DOMContentLoaded', () => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const utilityFilters = document.querySelectorAll('.utility-filter');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const propertyCards = document.querySelectorAll('.property-card');
    const noResultsMsg = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const clearFiltersBtn = document.getElementById('clear-filters');
    
    let activeLocation = 'all';
    let activeUtilities: string[] = [];
    let searchTerm = '';
    
    function filterProperties() {
      let visibleCount = 0;
      
      propertyCards.forEach((card) => {
        const cardElement = card as HTMLElement;
        const location = cardElement.dataset.location || '';
        const hasWater = cardElement.dataset.water === 'true';
        const hasElectricity = cardElement.dataset.electricity === 'true';
        const hasTelephone = cardElement.dataset.telephone === 'true';
        const title = cardElement.dataset.title || '';
        const desc = cardElement.dataset.desc || '';
        
        // Check location filter
        const locationMatch = activeLocation === 'all' || location === activeLocation;
        
        // Check utility filters
        let utilityMatch = true;
        if (activeUtilities.length > 0) {
          utilityMatch = activeUtilities.every(utility => {
            if (utility === 'water') return hasWater;
            if (utility === 'electricity') return hasElectricity;
            if (utility === 'telephone') return hasTelephone;
            return true;
          });
        }
        
        // Check search term
        const searchMatch = searchTerm === '' || 
                           title.includes(searchTerm) || 
                           desc.includes(searchTerm);
        
        // Show/hide card
        if (locationMatch && utilityMatch && searchMatch) {
          cardElement.style.display = 'flex'; // Use flex to maintain card layout
          setTimeout(() => cardElement.classList.remove('opacity-0'), 10);
          visibleCount++;
        } else {
          cardElement.classList.add('opacity-0');
          setTimeout(() => cardElement.style.display = 'none', 300);
        }
      });
      
      // Update UI states
      if (resultsCount) {
        resultsCount.textContent = `Showing ${visibleCount} propert${visibleCount !== 1 ? 'ies' : 'y'}`;
      }
      
      if (visibleCount === 0 && noResultsMsg) {
        noResultsMsg.classList.remove('hidden');
      } else if (noResultsMsg) {
        noResultsMsg.classList.add('hidden');
      }
    }
    
    // Location filter buttons
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-gold', 'text-navy-dark', 'font-bold');
          btn.classList.add('text-cream/80', 'hover:bg-navy-light', 'hover:text-white');
        });
        
        button.classList.add('active', 'bg-gold', 'text-navy-dark', 'font-bold');
        button.classList.remove('text-cream/80', 'hover:bg-navy-light', 'hover:text-white');
        
        activeLocation = (button as HTMLButtonElement).dataset.filter || 'all';
        filterProperties();
      });
    });
    
    // Set initial active state style for "All Properties"
    const allBtn = document.querySelector('.filter-btn[data-filter="all"]');
    if(allBtn) {
       allBtn.classList.add('active', 'bg-gold', 'text-navy-dark', 'font-bold');
    }
    
    // Utility filters
    utilityFilters.forEach(filter => {
      filter.addEventListener('change', (e) => {
        const target = e.target as HTMLInputElement;
        const utility = target.dataset.utility || '';
        
        if (target.checked) {
          activeUtilities.push(utility);
        } else {
          activeUtilities = activeUtilities.filter(u => u !== utility);
        }
        
        filterProperties();
      });
    });
    
    // Search input
    searchInput?.addEventListener('input', (e) => {
      searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
      filterProperties();
    });
    
    // Clear filters button
    clearFiltersBtn?.addEventListener('click', () => {
      // Reset location
      const allBtn = document.querySelector('.filter-btn[data-filter="all"]') as HTMLButtonElement;
      if (allBtn) allBtn.click();
      
      // Reset utilities
      utilityFilters.forEach(filter => {
        (filter as HTMLInputElement).checked = false;
      });
      activeUtilities = [];
      
      // Reset search
      if (searchInput) {
        searchInput.value = '';
        searchTerm = '';
      }
      
      filterProperties();
    });
  });
</script>

<style>
  .filter-btn.active {
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
  }
  
  .property-card {
    transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
